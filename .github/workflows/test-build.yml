name: SL3000 Ultimate Fix Build v3

on:
  workflow_dispatch:

env:
  CCACHE_DIR: ${{ github.workspace }}/.ccache

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    # âœ… 1. æ‹‰å–ä½ çš„ä»“åº“
    - name: Checkout Your Repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # âœ… 2. ç£ç›˜ä¼˜åŒ–
    - name: Free Disk Space
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache
        sudo apt-get clean
        df -h

    # âœ… 3. æ‹‰å–å®˜æ–¹ ImmortalWrt 24.10 (Linux 6.6)
    - name: Clone Official ImmortalWrt
      run: |
        git clone https://github.com/immortalwrt/immortalwrt.git source
        cd source
        git checkout openwrt-24.10

    # âœ… 4. è¦†ç›–ä½ çš„ mk/dts/config/patches
    - name: Apply Your Overlay
      run: |
        cp configs/sl3000.config source/.config
        mkdir -p source/target/linux/mediatek/dts
        cp dts/*.dts source/target/linux/mediatek/dts/
        mkdir -p source/target/linux/mediatek/image
        cp mk/*.mk source/target/linux/mediatek/image/
        if [ -d patches ]; then
          cp patches/*.patch source/
        fi

    # ğŸ” 5. æ£€æŸ¥è¡¥ä¸åº”ç”¨
    - name: Check Patch Application
      run: |
        cd source
        for p in ../patches/*.patch; do
          echo "Applying $p ..."
          patch -p1 < "$p" || true
        done
        find . -name "*.rej" > patch_failures.txt
        if [ -s patch_failures.txt ]; then
          echo "âš ï¸ Patch failed, see patch_failures.txt"
          for rej in $(cat patch_failures.txt); do
            orig=${rej%.rej}
            echo "=== Failed patch: $rej ===" >> patch_diff_report.log
            diff -u "$orig" "$rej" >> patch_diff_report.log || true
          done
          exit 1
        fi

    - name: Upload Patch Failure Report
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: patch-failure-report
        path: |
          source/patch_failures.txt
          source/patch_diff_report.log

    # âœ… 6. å®‰è£…ä¾èµ–
    - name: Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
          python3 python3-distutils rsync unzip zlib1g-dev file wget ccache

    # âœ… 7. ç¼“å­˜ dl
    - name: Cache DL
      uses: actions/cache@v4
      with:
        path: source/dl
        key: dl-${{ github.ref_name }}
        restore-keys: dl-

    # âœ… 8. ç¼“å­˜ ccache
    - name: Cache ccache
      uses: actions/cache@v4
      with:
        path: .ccache
        key: ccache-${{ github.ref_name }}

    # âœ… 9. ç¼“å­˜ toolchain + host + target
    - name: Cache Toolchain + Host + Target
      uses: actions/cache@v4
      with:
        path: |
          source/staging_dir
          source/toolchain
          source/build_dir/host-*
          source/build_dir/toolchain-*
          source/build_dir/target-*
        key: toolchain-host-target-${{ github.ref_name }}
        restore-keys: toolchain-host-target-

    # âœ… 10. feeds
    - name: Update Feeds
      run: |
        cd source
        ./scripts/feeds update -a
        ./scripts/feeds install -a -f

    # âœ… 11. å•ç‹¬ç¼–è¯‘ LLVMï¼ˆé™åˆ¶çº¿ç¨‹ï¼‰
    - name: Prebuild LLVM (Fix OOM)
      run: |
        cd source
        export MAKEFLAGS="-j2"
        make tools/llvm-bpf/compile V=s

    # âœ… 12. ç¼–è¯‘ worldï¼ˆè‡ªåŠ¨é‡è¯• + æ—¥å¿—ä¿å­˜ï¼‰
    - name: Build Firmware (Ultimate Retry)
      run: |
        cd source
        mkdir -p logs
        export MAKEFLAGS="-j4"

        for i in 1 2 3; do
          echo "=== Build attempt $i ==="
          timeout 60m make | tee logs/build_$i.log && break
          echo "Parallel build failed, retrying single job..."
          timeout 60m make -j1 V=s | tee logs/build_${i}_single.log && break
          echo "Attempt $i failed"
        done

        if ! ls bin/targets/mediatek/filogic/*sysupgrade*.bin >/dev/null 2>&1; then
          echo "Build failed after 3 attempts"
          exit 1
        fi

    # âœ… 13. æ£€æŸ¥å›ºä»¶è¾“å‡º
    - name: Check Firmware Output
      run: |
        TARGET_DIR=source/bin/targets/mediatek/filogic
        echo "=== Firmware output ==="
        ls -lh "$TARGET_DIR"

    # âœ… 14. ä¸Šä¼ æ„å»ºäº§ç‰© + æ—¥å¿—
    - name: Upload Test Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sl3000-test-output
        path: |
          source/bin/targets/mediatek/filogic/
          source/logs/
